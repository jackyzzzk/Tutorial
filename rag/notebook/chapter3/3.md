# ç¬¬3è®²ï¼šå¤§æ¨¡å‹æ€ä¹ˆç©ï¼šç”¨LazyLLMå¸¦ä½ ç†è§£è°ƒç”¨é€»è¾‘ä¸Prompté­”æ³•

>ä¸ŠæœŸï¼Œæˆ‘ä»¬ä»‹ç»äº†åŸºç¡€çš„RAGçš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•ç”¨LazyLLMå®ç°ä¸€ä¸ªåŸºç¡€çš„RAGã€‚æœ¬æœŸæˆ‘ä»¬å°†æ·±å…¥ä»‹ç»LazyLLMçš„ç‰¹æ€§ï¼Œä»¥Lazyçš„æ–¹å¼ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°åœ°æ„å»ºå‡ºä¸€ä¸ªä»¥æ•°æ®æµä¸ºæ ¸å¿ƒèŒƒå¼çš„RAGåº”ç”¨ã€‚
>
>åœ¨æ­¤æ¬¡æ•™ç¨‹ä¸­ï¼Œæ‚¨ä¸ä»…å¯ä»¥å­¦ä¹ åˆ°LazyLLMä¸­çš„å„ç§æ•°æ®æµçš„ä½¿ç”¨ã€è¿˜å¯ä»¥æ›´åŠ æ·±å…¥åœ°å­¦åˆ°å¦‚ä½•ä½¿ç”¨åœ¨çº¿å’Œæœ¬åœ°çš„å¤§æ¨¡å‹ï¼Œå¹¶ä¸ºå®ƒä»¬è®¾ç½®ä¸ŠPromptï¼ŒåŒæ—¶è¿˜å¯ä»¥å¤ç”¨åŒä¸€ä¸ªæœ¬åœ°å¤§æ¨¡å‹æ¥æ„å»ºå¤šä¸ªä¸åŒè§’è‰²çš„å¤§æ¨¡å‹ï¼Œæœ€åæœ¬æ•™ç¨‹å°†å¸¦é¢†æ‚¨ä¸€æ­¥æ­¥ä¼˜åŒ–ä¸ŠæœŸRAGï¼Œä»¥LazyLLMä¸­çš„æ•°æ®æµæ¥é‡æ„åŸºç¡€RAG!
>
>è®©æˆ‘ä»¬å¼€å§‹å§\~
>
æ¬¢è¿æ¥åˆ° LazyLLMï¼

LazyLLM æ˜¯ä¸€æ¬¾æ„å»ºå¤šAgentå¤§æ¨¡å‹åº”ç”¨çš„å¼€å‘æ¡†æ¶ï¼ŒååŠ©å¼€å‘è€…ç”¨æä½çš„æˆæœ¬æ„å»ºå¤æ‚çš„AIåº”ç”¨ï¼Œå¹¶å¯ä»¥æŒç»­çš„è¿­ä»£ä¼˜åŒ–æ•ˆæœã€‚åŸºäºLazyLLMçš„AIåº”ç”¨æ„å»ºæµç¨‹æ˜¯ï¼š

**åŸå‹æ­å»º â†’ æ•°æ®**â€‹**åˆ†æ**â€‹**â€‹ â†’ è¿­ä»£ä¼˜åŒ–**

ç”¨æˆ·å¯ä»¥å…ˆåŸºäºLazyLLMå¿«é€Ÿè·‘é€šåº”ç”¨çš„åŸå‹ï¼Œå†ç»“åˆåœºæ™¯ä»»åŠ¡æ•°æ®è¿›è¡Œbad-caseåˆ†æï¼Œç„¶åå¯¹åº”ç”¨ä¸­çš„å…³é”®ç¯èŠ‚è¿›è¡Œç®—æ³•è¿­ä»£å’Œæ¨¡å‹å¾®è°ƒï¼Œè¿›è€Œé€æ­¥æå‡æ•´ä¸ªåº”ç”¨çš„æ•ˆæœã€‚LazyLLM çš„è®¾è®¡ç›®æ ‡æ˜¯è®©ç®—æ³•ç ”ç©¶å‘˜å’Œå¼€å‘è€…èƒ½å¤Ÿä»ç¹æ‚çš„å·¥ç¨‹å®ç°ä¸­è§£è„±å‡ºæ¥ï¼Œä»è€Œä¸“æ³¨ç®—æ³•å’Œæ•°æ®ã€‚

LazyLLMä¸ºåŒä¸€æ¨¡å—çš„ä¸åŒæŠ€æœ¯é€‰å‹æä¾›äº†ä¸€è‡´çš„ä½¿ç”¨ä½“éªŒ -- ç»Ÿä¸€è°ƒç”¨ã€ç»Ÿä¸€æœåŠ¡ã€ç»Ÿä¸€éƒ¨ç½²ã€‚

![](3_images/img1.png)

å¯¹äºåˆçº§å¼€å‘è€…ï¼ŒLazyLLM å½»åº•ç®€åŒ–äº†AIåº”ç”¨çš„æ„å»ºè¿‡ç¨‹ã€‚ç”¨æˆ·ä¸å¿…äº†è§£ä¸åŒæ¨¡å‹ API æœåŠ¡çš„æ„å»ºç»†èŠ‚ï¼Œæ— éœ€åœ¨å¾®è°ƒæ¨¡å‹æ—¶é€‰æ‹©æ¡†æ¶æˆ–åˆ‡åˆ†æ¨¡å‹ï¼Œä¹Ÿä¸éœ€è¦æŒæ¡ä»»ä½•Webå¼€å‘çŸ¥è¯†ï¼Œé€šè¿‡é¢„ç½®çš„ç»„ä»¶å’Œç®€å•çš„æ‹¼æ¥æ“ä½œï¼Œåˆçº§å¼€å‘è€…ä¾¿èƒ½è½»æ¾æ„å»ºå‡ºå…·å¤‡ç”Ÿäº§ä»·å€¼çš„å·¥å…·ã€‚

å¯¹äºèµ„æ·±çš„ä¸“å®¶ï¼ŒLazyLLM æä¾›äº†æé«˜çš„çµæ´»æ€§ï¼Œä¸ºå¼€å‘è€…æä¾›äº†æ— é™çš„å¯èƒ½æ€§ã€‚å…¶æ¨¡å—åŒ–è®¾è®¡æ”¯æŒé«˜åº¦çš„å®šåˆ¶ä¸æ‰©å±•ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾é›†æˆè‡ªæœ‰ç®—æ³•ã€è¡Œä¸šé¢†å…ˆçš„ç”Ÿäº§å·¥å…·ä»¥åŠæœ€æ–°çš„æŠ€æœ¯æˆæœï¼Œä»è€Œå¿«é€Ÿæ„å»ºé€‚é…å¤šæ ·åŒ–éœ€æ±‚çš„å¼ºå¤§åº”ç”¨ã€‚

æœ¬æ•™ç¨‹ä¸»è¦ä»‹ç» LazyLLM çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œè¯»å®Œæœ¬æ•™ç¨‹ï¼Œæ‚¨å°†å­¦ä¼š LazyLLM æœ€åŸºæœ¬çš„ç”¨æ³•å’Œæ ¸å¿ƒè®¾è®¡æ€è·¯ï¼Œå¯ä»¥è‡ªå·±æ­å»ºä¸€ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººï¼Œä¸ºå…¶æŒ‡å®šè§’è‰²å¹¶è¿›è¡ŒèŠå¤©ã€‚

æ›´å¤šLazyLLMä½¿ç”¨æ•™ç¨‹åŠAPIæ–‡æ¡£è¯·å‚è€ƒï¼š[LazyLLMå®˜æ–¹æ–‡æ¡£](https://docs.lazyllm.ai/zh-cn/stable/) æˆ– Bç«™ä¸€é”®ä¸‰è¿ï¼š

[ç›¸å…³è§†é¢‘ï¼švideo/1.å±…ç„¶æœ‰æ¯”LangChainè¿˜å¥½ç”¨çš„å¤šAgentåº”ç”¨å¼€å‘æ¡†æ¶ï¼Ÿ(Av113632839013182,P1).mp4](video/1.å±…ç„¶æœ‰æ¯”LangChainè¿˜å¥½ç”¨çš„å¤šAgentåº”ç”¨å¼€å‘æ¡†æ¶ï¼Ÿ(Av113632839013182,P1).mp4)

## ç¯å¢ƒçš„å‡†å¤‡ âœˆ

å¦‚æœæ‚¨çš„ç”µè„‘ä¸Šå®‰è£…äº†Pythonï¼Œè¯·é€šè¿‡ä¸‹æ–¹å‘½ä»¤å®‰è£…åŸºç¡€çš„lazyllmåŠå¿…è¦çš„ä¾èµ–åŒ…ã€‚æ›´å¤šLazyLLMçš„å®‰è£…ç»†èŠ‚ï¼Œå¯è§ä¸ŠæœŸçš„æ•™ç¨‹çš„ç¯å¢ƒå‡†å¤‡éƒ¨åˆ†ã€‚

**ä»pipå®‰è£…**


```bash
pip install lazyllm
```

**ä»æºç å®‰è£…**


```bash
git clone https://github.com/LazyAGI/LazyLLM.git
cd LazyLLM
pip3 install -r requirements.txt
export PYTHONPATH=$PWD:$PYTHONPATH
```



## è°ƒç”¨å¤§æ¨¡å‹ ğŸ¤–

LazyLLMæ”¯æŒè°ƒç”¨çº¿ä¸Šæ¨¡å‹å’Œæœ¬åœ°æ¨¡å‹ï¼Œä¸ºäºŒè€…æä¾›äº†ä¸€è‡´çš„ä½¿ç”¨ä½“éªŒï¼Œåšåˆ°æ¨¡å‹å³é»‘ç›’ï¼Œæ‚¨åªéœ€å…³æ³¨è¾“å…¥è¾“å‡ºåŠç›¸å…³å‚æ•°çš„å…·ä½“å–å€¼ï¼Œè€Œæ— éœ€ç ”ç©¶ä¸åŒæ¨¡å‹è°ƒç”¨ä¸Šçš„å·®å¼‚ã€‚

![image.png](3_images/img2.png)
 ### 1. è°ƒç”¨åœ¨çº¿å¤§æ¨¡å‹ ğŸŒ

LazyLLM é€šè¿‡ OnlineChatModule ç»Ÿä¸€è°ƒç”¨çº¿ä¸Šå¤§æ¨¡å‹æ¥å£ï¼Œä¸ç®¡æ‚¨ä½¿ç”¨çš„OpenAPIæ¥å£è¿˜æ˜¯SenseNovaæ¥å£ï¼Œæˆ–è€…æ˜¯å…¶ä»–å¹³å°æä¾›çš„æ¥å£ï¼ŒLazyLLMå‡ä¸ºæ‚¨è¿›è¡Œäº†è§„èŒƒçš„å‚æ•°å°è£…ï¼Œæ‚¨åªéœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚å°†æ¨¡å‹åç§°ç­‰å‚æ•°ä¼ ç»™å¯¹åº”çš„æ¨¡å—å³å¯ã€‚

â—â—â— æ³¨æ„ï¼Œæ‚¨éœ€è¦åœ¨å¼€å§‹è°ƒè¯•å‰ï¼Œå°†æ‚¨çš„API keyè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œå¦‚æ‚¨æ²¡æœ‰æŒ‡å®šä»»ä½•ç¯å¢ƒå˜é‡ç¨‹åºå°†æŠ¥é”™ã€‚æ‚¨å¯ä»¥å‚è€ƒä¸ŠæœŸæ•™ç¨‹è¿›è¡Œè®¾ç½®ã€‚ä¾‹å¦‚å½“æ‚¨éœ€è¦è®¿é—®SenseNovaæ—¶ï¼Œæ‚¨éœ€è¦è®¾å®šç¯å¢ƒå˜é‡:



```bash
export LAZYLLM_SENSENOVA_API_KEY="..."
export LAZYLLM_SENSENOVA_SECRET_KEY="..."
```



å¦‚æœæ‚¨åªé…ç½®äº†ä¸€ä¸ªå¹³å°çš„API keyï¼Œåˆ™æ— éœ€æŒ‡å®šå¹³å°åç§°ï¼Œç›´æ¥è°ƒç”¨ OnlineChatModule å³å¯ã€‚å¦‚æœé…ç½®äº†å¤šä¸ªå¹³å°çš„API keyï¼Œåœ¨æ²¡æŒ‡å®šå¹³å°åç§°çš„æƒ…å†µä¸‹ï¼Œä¼šæŒ‰ç…§openai>sensenova>glm>kimi>qwençš„é¡ºåºè¿›è¡Œå¹³å°æŸ¥æ‰¾ã€‚å½“æ‚¨éœ€è¦æŒ‡å®šå…·ä½“å¹³å°æ—¶ï¼Œéœ€è¦ä¸ºOnlineChatModuleä¼ å…¥å¹³å°åç§°ï¼›å¦‚æœéœ€è¦æŒ‡å®šå…·ä½“æ¨¡å‹ï¼Œåˆ™éœ€è¦ä¼ å…¥å¯¹åº”æ¨¡å‹åç§°ã€‚



```python
llm = lazyllm.OnlineChatModule(source="sensenova")

# æŒ‡å®šå…·ä½“æ¨¡å‹
sensechat = lazyllm.OnlineChatModule("sensenova", model="SenseChat-5")
```



ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨LazyLLMè°ƒç”¨ä¸€ä¸ªçº¿ä¸Šæ¨¡å‹ï¼ˆå·²åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®äº†SenseNovaç›¸å…³çš„KEYï¼‰



```python
import lazyllm

online_model = lazyllm.OnlineChatModule()
print(online_model("ä½ å¥½ï¼Œä½ æ˜¯è°?"))
```



[ç›¸å…³è§†é¢‘ï¼švideo/a1chat_online1.mp4](video/a1chat_online1.mp4)

å¦‚æœæ‚¨æ²¡æœ‰å¼€é€šç›¸åº”çš„æ¨¡å‹æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡è¾“å…¥ model å‚æ•°æŒ‡å®šæ¨¡å‹ï¼Œä¾‹å¦‚



```python
import lazyllm

online_model = lazyllm.OnlineChatModule(source="sensenova", model="DeepSeek-V3")
print(online_model("ä½ å¥½ï¼Œä½ æ˜¯DeepSeekå—ï¼Ÿ"))
```



[ç›¸å…³è§†é¢‘ï¼švideo/a1chat_online2.mp4](video/a1chat_online2.mp4)

 ### 2. è°ƒç”¨æœ¬åœ°å¤§æ¨¡å‹ ğŸ’»

LazyLLM ä¸­çš„ TrainableModule ä¸ºæ‰€æœ‰æœ¬åœ°æ¨¡å‹(åŒ…æ‹¬llmã€Embeddingã€å¤šæ¨¡æ€æ¨¡å‹ç­‰)æä¾›æœåŠ¡ï¼Œå¯ç”¨äºæœ¬åœ°æ¨¡å‹çš„è®­ç»ƒã€å¾®è°ƒå’Œæ¨ç†ã€‚è°ƒç”¨æœ¬åœ°å¤§æ¨¡å‹ä¾èµ–äºå…¶æ¨ç†æœåŠ¡ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä½¿ç”¨æœ¬åœ°æ¨¡å‹è¿›è¡Œæ¨ç†çš„æ­¥éª¤ï¼š

ï¼ˆ1ï¼‰é€šè¿‡æ¨ç†æ¡†æ¶å¯åŠ¨æœ¬åœ°æ¨¡å‹æœåŠ¡ï¼›

ï¼ˆ2ï¼‰åœ¨pythonè„šæœ¬ä¸­è¿›è¡Œæ¥å£è°ƒç”¨ã€‚

LazyLLMæä¾›äº†ä¸€ç§éå¸¸ lazy çš„å®ç°æ–¹å¼ï¼Œåªéœ€å°†æ¨¡å‹æ‰€åœ¨çš„è·¯å¾„ä¼ å…¥ LazyLLM çš„`TrainableModule `ç„¶åé€šè¿‡`start()`å‡½æ•°å¯åŠ¨æœåŠ¡å³å¯ã€‚è¿™é‡Œéœ€è¦æ‚¨ä¼ å…¥æ¨¡å‹æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œæˆ–è€…é…ç½®ç¯å¢ƒå˜é‡`LAZYLLM_MODEL_PATH`æŒ‡å®šæ¨¡å‹æ‰€åœ¨çš„ç›®å½•ï¼Œç„¶åå°†æ¨¡å‹åç§°ä¼ å…¥`TrainableModule`ã€‚å¦‚æœæ‚¨æœ¬åœ°æ²¡æœ‰è¯¥æ¨¡å‹ï¼ŒLazyLLMä¼šä¸ºæ‚¨ä¸‹è½½å¯¹åº”æ¨¡å‹å¹¶å­˜å…¥æ¨¡å‹ç¼“å­˜ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä¸‹è½½åˆ°æ‚¨çš„å®¶ç›®å½•ä¸‹çš„ ".lazyllm/model" ç›®å½•ï¼›æ‚¨å¯ä»¥é€šè¿‡é…ç½® `â€œLAZYLLM_MODEL_CACHE_DIRâ€ `ç¯å¢ƒå˜é‡æŒ‡å®šæ¨¡å‹ç¼“å­˜ç›®å½•ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ LazyLLM æ”¯æŒå¤šç§æ¨ç†æ¡†æ¶ï¼Œå¦‚ï¼šLightLLM å’Œ vLLMç­‰ï¼Œåœ¨ä¸æŒ‡å®šæ˜ç¡®æ¡†æ¶ä¸‹LazyLLMä¼šæ ¹æ®æ¨¡å‹å¤§å°å’Œæµ‹è¯•æ•°æ®ç­‰ä¿¡æ¯ï¼Œè‡ªåŠ¨ä¸ºç”¨æˆ·é€‰æ‹©åˆé€‚çš„æ¨ç†æ¡†æ¶ã€‚å¦‚æœè¦æ˜ç¡®æŒ‡å®šä¸€ä¸ªæ¨ç†æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆæ¥è®¾å®šï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/chat_local.py#L1)

```python
import lazyllm
from lazyllm import deploy

llm = lazyllm.TrainableModule('internlm2-chat-7b').\
        deploy_method((deploy.Vllm, {
            'port': 8081,
            'host': '0.0.0.0',
        })).start()
res = llm('hi')
print("å¤§æ¨¡å‹çš„è¾“å‡ºæ˜¯ï¼š", res)
```



ä¸Šé¢ä»£ç ä¸­ï¼Œä½¿ç”¨`deploy_method`æ¥é…ç½®æ¨ç†æ¡†æ¶ï¼š

* `deploy.Vllm` æŒ‡å®šä½¿ç”¨vLLMä½œä¸ºæ¨ç†å¼•æ“ï¼›
* `host` å’Œ` port` å‚æ•°åˆ†åˆ«æŒ‡å®šäº†æœåŠ¡éƒ¨ç½²æ—¶å€™çš„IPå’Œåœ°å€ï¼›

[ç›¸å…³è§†é¢‘ï¼švideo/a1chat_local.mp4](video/a1chat_local.mp4)

 ### 3. Prompté…ç½®ä½¿ç”¨ğŸ’­

Prompt æ˜¯æŒ‡åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æˆ–äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰ç³»ç»Ÿä¸­è¾“å…¥ç»™æ¨¡å‹çš„æ–‡æœ¬æˆ–æŒ‡ä»¤ï¼Œæ˜¯ä¸æ¨¡å‹äº¤äº’çš„ä¸»è¦æ–¹å¼ã€‚Prompt ä¸ä»…æ˜¯ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ï¼Œå®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹æ˜¯æ¨¡å‹ç†è§£ä»»åŠ¡çš„å…³é”®ï¼Œé€šè¿‡è®¾è®¡åˆé€‚çš„ Promptï¼Œæˆ‘ä»¬å¯ä»¥å¼•å¯¼æ¨¡å‹ä»¥ç‰¹å®šçš„æ–¹å¼ç”Ÿæˆæ‰€éœ€çš„å“åº”ã€‚

Prompt çš„ä¸»è¦ä½œç”¨æ˜¯ç»™æ¨¡å‹æä¾›ä»»åŠ¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨å¯¹è¯ä¸­ï¼Œæ¨¡å‹ä¼šæ ¹æ®é¢„å®šä¹‰çš„ç³»ç»Ÿè¯´æ˜å’Œç”¨æˆ·è¾“å…¥è¿›è¡Œå›å¤ã€‚ä¸åŒçš„æç¤ºä¼šå¼•å¯¼æ¨¡å‹ç”Ÿæˆä¸åŒçš„ç­”æ¡ˆã€‚å› æ­¤ï¼ŒPrompt çš„è®¾è®¡ç›´æ¥å½±å“åˆ°ç”Ÿæˆå†…å®¹çš„è´¨é‡ã€å‡†ç¡®æ€§å’Œç›¸å…³æ€§ã€‚åˆ©ç”¨å¤§æ¨¡å‹è¿›è¡Œé—®ç­”ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Prompt æŒ‡å®šå¤§æ¨¡å‹æ‰®æ¼”çš„è§’è‰²ä»¥åŠå›ç­”é—®é¢˜çš„é£æ ¼ç­‰ã€‚

#### åŸºç¡€çš„Prompt

ä½¿ç”¨ LazyLLM æä¾›çš„ Prompt æ¨¡æ¿ï¼Œæ‚¨åªéœ€è¦åœ¨åˆå§‹åŒ–å¤§æ¨¡å‹æ—¶é€šè¿‡å¦‚ä¸‹è¯­æ³•è¿›è¡Œå®šä¹‰ï¼Œåœ¨è°ƒç”¨æ—¶ç›´æ¥ä¼ å…¥ç”¨æˆ·è¾“å…¥å³å¯ã€‚ä¸‹é¢å®šä¹‰äº†ä¸¤ä¸ªå¤§æ¨¡å‹llm1å’Œllm2ï¼Œllm1æ˜¯ä¸€ä¸ªé»˜è®¤çš„åœ¨çº¿å¤§æ¨¡å‹ï¼Œllm2æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰äº†promptçš„åœ¨çº¿å¤§æ¨¡å‹ï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/prompt_with_llm_base.py#L1)

```python
import lazyllm

llm1 = lazyllm.OnlineChatModule()
llm2 = lazyllm.OnlineChatModule().prompt("ä½ æ˜¯ä¸€åªå°çŒ«ï¼Œåœ¨æ¯æ¬¡å›ç­”é—®é¢˜ä¹‹åéƒ½è¦åŠ ä¸Šå–µå–µå–µ")

print('æ™®é€šæƒ…å†µä¸‹æ¨¡å‹çš„è¾“å‡º:   ', llm1('ä½ å¥½'))
print('è‡ªå®šä¹‰Promptåæ¨¡å‹çš„è¾“å‡º: ', llm2('ä½ å¥½'))
```

è®©æˆ‘ä»¬çœ‹çœ‹ä¸Šè¿°ä»£ç çš„è¾“å‡ºï¼š
```bash
æ™®é€šæƒ…å†µä¸‹æ¨¡å‹çš„è¾“å‡º:    ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
è‡ªå®šä¹‰Promptåæ¨¡å‹çš„è¾“å‡º:  ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿå–µå–µå–µ
```

çœ‹å¯ä»¥çœ‹åˆ°åœ¨è‡ªå®šä¹‰promptæ¨¡æ¿åï¼Œå¤§æ¨¡å‹æŒ‰ç…§æˆ‘ä»¬çš„è¦æ±‚åœ¨å›ç­”ååŠ ä¸Šäº†â€œå–µå–µå–µâ€ã€‚

[ç›¸å…³è§†é¢‘ï¼švideo/a2prompt1.mp4](video/a2prompt1.mp4)

#### åŠ¨æ€çš„Prompt

åé¢æˆ‘ä»¬ä¼šé‡åˆ°promptä¸­éœ€è¦æ¤å…¥é¢å¤–çš„å†…å®¹ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åœ¨promptä¸­æ’å…¥äº†ä¸€ä¸ªå˜é‡ä½œä¸ºå ä½ç¬¦ï¼Œç„¶ååœ¨æ¨ç†çš„è¿‡ç¨‹ä¸­è¯¥å˜é‡å¯ä»¥æ›¿æ¢ä¸ºæˆ‘ä»¬å¸Œæœ›çš„å†…å®¹ã€‚ä¸ºäº†å®ç°è¿™æ ·ä¸€ç§åŠ¨æ€çš„Promptï¼Œå…·ä½“è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªä¾‹å­ï¼š

[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/prompt_with_llm_placeholder.py#L1)

```python
import lazyllm

llm2 = lazyllm.OnlineChatModule().prompt("æ ¹æ®ç»™å‡ºçš„æ–‡æ®µå›ç­”é—®é¢˜ï¼Œæ–‡æ®µï¼š{content}")

passage = ('å­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚'
           'è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›')

# ä¸‹é¢æ‰“å°promt_contentä»…åšå±•ç¤ºï¼Œå®é™…ä¸éœ€è¦ï¼š
prompt_content = llm2._prompt.generate_prompt({'input':'å­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ', 'content':passage}, return_dict=True)
print(prompt_content)

# æ¨¡å‹æ¨ç†ï¼š
print(llm2({'input':'å­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ', 'content':passage}))
```



ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œèƒ½æŠŠæ–‡æ®µä¿¡æ¯æ›¿æ¢\`{content}\`ï¼Œè¿™é‡Œæˆ‘ä»¬å–äº†ä¸ªå˜é‡åå«åš`content`ï¼Œæ‚¨å¯ä»¥å–ä»»æ„å…¶ä»–å˜é‡åï¼ˆé™¤äº†`input`ï¼‰ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ ¹æ®å†…å®¹ç”¨`generate_prompt`æ‹¼æ¥äº†å†…å®¹ (å…¶ä¸­`return_dict`ç”¨äºçº¿ä¸Šæ¨¡å‹çš„æ ¼å¼è¾“å‡ºï¼Œé»˜è®¤ä¼šæ˜¯çº¿ä¸‹æ¨¡å‹çš„æ ¼å¼è¾“å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨çš„æ¨¡å‹æ˜¯åœ¨çº¿QWenå¤§æ¨¡å‹ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯è¿™ä¸ªå‚æ•°ï¼Œå¦åˆ™è¾“å‡ºæ ¼å¼å°±æ˜¯çº¿ä¸‹çš„æ ¼å¼)ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰“å°æŸ¥çœ‹äº†ä¸€ä¸ªå®ƒæ‹¼æ¥æˆçš„å†…å®¹`print(prompt_content)`ï¼š

```Bash
{'messages': [{'role': 'system', 'content': 'You are a large-scale language model from Alibaba Cloud, your name is Tongyi Qianwen, and you are a useful assistant.\næ ¹æ®ç»™å‡ºçš„æ–‡æ®µå›ç­”é—®é¢˜ï¼Œæ–‡æ®µï¼šå­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›\n\n'}, {'role': 'user', 'content': 'å­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ'}]}
```

æœªå¼€å¯`return_dict`ä¸‹çš„æ‹¼æ¥å†…å®¹å±•ç¤ºï¼š

```Bash
'You are a large-scale language model from Alibaba Cloud, your name is Tongyi Qianwen, and you are a useful assistant.æ ¹æ®ç»™å‡ºçš„æ–‡æ®µå›ç­”é—®é¢˜ï¼Œæ–‡æ®µï¼šå­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›\n\n\n\n\n\nå­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ\n\n'
```

ä»æ‹¼æ¥åçš„æ¨¡æ¿å†…å®¹å¯ä»¥çœ‹åˆ°è¿™æ˜¯ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸçš„ï¼šå†…å®¹è¢«åŠ¨æ€æ‹¼æ¥åˆ°äº†Promptæ¨¡æ¿ä¸­ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŸ¥çœ‹é€å…¥å¤§æ¨¡å‹åè¾“å‡ºçš„å®é™…æ•ˆæœï¼š

```bash
å­™æ‚Ÿç©ºæœ‰ä»¥ä¸‹å‡ ä¸ªåå­—å’Œåˆ«ç§°ï¼š

1. å­™è¡Œè€…
2. å­™çŒ´å­
3. ç¾çŒ´ç‹ï¼ˆè‡ªå°ï¼‰
4. é½å¤©å¤§åœ£ï¼ˆè‡ªå°ï¼‰
5. å¼¼é©¬æ¸©ï¼ˆæ›¾æŒç®¡å¤©åº­å¾¡é©¬ç›‘ï¼‰

åœ¨å–å¾—çœŸç»åï¼Œä»–è¿˜è¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºâ€œæ–—æˆ˜èƒœä½›â€ã€‚
```

å¯ä»¥çœ‹åˆ°æ¨¡å‹æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚æ­£ç¡®ä»æ–‡æœ¬æ®µä¸­æå–å‡ºæ¥äº†å†…å®¹ã€‚

[ç›¸å…³è§†é¢‘ï¼švideo/a2prompt2.mp4](video/a2prompt2.mp4)

#### ç‹¬ç«‹çš„Prompt

å‰é¢ä»‹ç»çš„Promptéƒ½æ˜¯åœ¨å¤§æ¨¡å‹ä¸Šç›´æ¥è®¾ç½®çš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å•ç‹¬å…ˆå®šä¹‰å¥½ä¸€ä¸ªPromptï¼Œç„¶åå†ç»™å®ƒè®¾ç½®ç»™å¤§æ¨¡å‹æ¥ä½¿ç”¨ï¼ˆè¿™æ ·å®šä¹‰å¥½ä¸€ä¸ªPromptå°±å¯ä»¥è®¾ç½®ç»™ä¸åŒçš„å¤§æ¨¡å‹ä½¿ç”¨äº†ï¼‰ã€‚LazyLLMä¸»è¦æœ‰ä¸¤ç§Promptï¼šAlpacaPrompter å’Œ ChatPrompter(å‰é¢å…¶å®ç”¨åˆ°çš„éƒ½æ˜¯è¿™ç§ChatPrompter)ã€‚å®ƒä»¬ä¸¤è€…ä¸»è¦æ˜¯æ ¼å¼ä¸ä¸€æ ·ï¼Œå…·ä½“æ¥è¯´ï¼š

`AlpacaPrompter `:

```Bash
{system}\n{instruction}\n{tools}\n{user}### Response:\n
```

`ChatPrompter`ï¼š

```Bash
{sos}{system}{instruction}{tools}{eos}\n\n{history}\n{soh}\n{user}{input}\n{eoh}{soa}\n
```

å…¶ä¸­ï¼š

* `instruction`: ä»»åŠ¡æŒ‡ä»¤ï¼Œæˆ‘ä»¬å‰é¢è®¾ç½®çš„Promptå†…å®¹ä¸»è¦å°±æ˜¯è¿™ä¸ªéƒ¨åˆ†ï¼›
* `history`: å†å²å¯¹è¯ï¼Œç”±ç”¨æˆ·çš„è¾“å…¥å¾—åˆ°ï¼Œæ ¼å¼ä¸º `[[a, b], [c, d]]` æˆ– `[{"role": "user", "content": ""}, {"role": "assistant", "content": ""}]`
* `tools`: å¯ä»¥ä½¿ç”¨çš„å·¥å…·ï¼Œåœ¨æ„é€  `prompter` æ—¶ä¼ å…¥æˆ–è€…ç”±ç”¨æˆ·ä½¿ç”¨æ—¶ä¼ å…¥ï¼Œå½“æ„é€  `prompter` æ—¶å®šä¹‰äº†å·¥å…·ä¹‹åï¼Œå°†ç¦æ­¢ç”¨æˆ·ä½¿ç”¨æ—¶å†æ¬¡ä¼ å…¥ã€‚æ ¼å¼ä¸º `[{"type": "function", "function": {"name": "", "description": "", "parameters": {}, "required": []}]`
* `user`: ç”¨æˆ·çº§æŒ‡ä»¤ï¼Œå¯é€‰æŒ‡ä»¤ã€‚ç”±ç”¨æˆ·é€šè¿‡ `instruction`æŒ‡å®šï¼Œå¦‚æœ `instruction`æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™é»˜è®¤æ˜¯ç³»ç»ŸæŒ‡ä»¤ï¼Œå¦‚æœæ˜¯å­—å…¸ï¼Œä¸”å…¶é”®å€¼åªèƒ½æ˜¯ `system` å’Œ `user` ã€‚`system` æŒ‡å®šçš„æ˜¯ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œ `user` æŒ‡å®šçš„æ˜¯ç”¨æˆ·çº§æŒ‡ä»¤ã€‚

ç”±æ¨¡å‹å½’å±ä¿¡æ¯è‡ªåŠ¨å¡«å…¥çš„å‚æ•°ï¼ˆç”¨æˆ·å’Œå¼€å‘è€…éƒ½ä¸ç”¨å…³å¿ƒå¦‚ä½•å¡«å…¥è¿™éƒ¨åˆ†ä¿¡æ¯ï¼ŒLazyLLMä¼šè‡ªåŠ¨å¤„ç†ï¼Œè¿™é‡Œåšäº†è§£å°±å¥½ï¼‰ï¼š

* `system`: ç³»ç»Ÿæç¤ºï¼Œä¸€èˆ¬ä¼šè¯»å–æ¨¡å‹çš„å½’å±ä¿¡æ¯å¹¶è¿›è¡Œè®¾ç½®ï¼ˆå½“è®¾ç½®åˆ°æŸä¸ªæ¨¡å‹ä¸Šåä¼šè‡ªåŠ¨è®¾ç½®ä¸Šï¼‰ï¼Œå¦‚ä¸è®¾ç½®é»˜è®¤ä¸º `You are an AI-Agent developed by LazyLLM.` ï¼›
* sos: `start of system` , æ ‡å¿—ç€ç³»ç»Ÿæç¤ºçš„å¼€å§‹ï¼›
* eos: `end of system` , æ ‡å¿—ç€ç³»ç»Ÿæç¤ºçš„ç»“æŸï¼›
* soh: `start of human` , æ ‡å¿—ç€ç”¨æˆ·è¾“å…¥çš„å¼€å§‹ï¼›
* eoh: `end of human` , æ ‡å¿—ç€ç”¨æˆ·è¾“å…¥çš„ç»“æŸï¼›
* soa: `start of assistant` , æ ‡å¿—ç€æ¨¡å‹è¾“å‡ºçš„å¼€å§‹ï¼›
* eoa: `end of assistant` , æ ‡å¿—ç€æ¨¡å‹è¾“å‡ºçš„ç»“æŸï¼›

è®©æˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸¤ç§ç‹¬ç«‹çš„Promptçš„æ‹¼åˆæ•ˆæœï¼š

å‡è®¾æ–‡æ®µå’Œç”¨æˆ·æé—®æ˜¯ï¼š



```python
import lazyllm

passage = ('å­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚'
           'è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›')
query = 'å­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ'
```



AlpacaPrompter(ç‹¬ç«‹)



```python
prompter1 = lazyllm.AlpacaPrompter({
    'system': 'ç³»ç»ŸæŒ‡ä»¤',
    'user': 'ç”¨æˆ·æŒ‡ä»¤ã€‚\n### æ–‡æ®µå†…å®¹ï¼š{content}\n### é—®é¢˜ï¼š{input}\n'
    })
content = prompter1.generate_prompt({'input':query,'content':passage})
print("\nç‹¬ç«‹Prompt(Alpaca):\n", repr(content))
```



è¾“å‡ºï¼š



```bash
ç‹¬ç«‹Prompt(Alpaca):
 'You are an AI-Agent developed by LazyLLM.\nBelow is an instruction that describes a task, paired with extra messages such as input that provides further context if possible. Write a response that appropriately completes the request.\n\n### Instruction:\nç³»ç»ŸæŒ‡ä»¤\n\nç”¨æˆ·æŒ‡ä»¤ã€‚\n### æ–‡æ®µå†…å®¹ï¼šå­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›\n### é—®é¢˜ï¼šå­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ\n### Response:\n'
```



ChatPrompterï¼ˆç‹¬ç«‹ï¼‰



```python

prompter2 = lazyllm.ChatPrompter({
    'system': 'ç³»ç»ŸæŒ‡ä»¤',
    'user': 'ç”¨æˆ·æŒ‡ä»¤ã€‚\n### æ–‡æ®µå†…å®¹ï¼š{content}\n### é—®é¢˜ï¼š{input}\n'
    })
content = prompter2.generate_prompt({'input':query,'content':passage})
print("\nç‹¬ç«‹Prompt(Chat):\n", repr(content))

```



è¾“å‡ºï¼š



```bash
ç‹¬ç«‹Prompt(Chat):
 'You are an AI-Agent developed by LazyLLM.ç³»ç»ŸæŒ‡ä»¤\n\n\n\nç”¨æˆ·æŒ‡ä»¤ã€‚\n### æ–‡æ®µå†…å®¹ï¼šå­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›\n### é—®é¢˜ï¼šå­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ\n\n\n'
```



ç°åœ¨å†è®©æˆ‘ä»¬æŠŠå®ƒå¡åˆ°æ¨¡å‹é‡Œï¼Œè®©æ¨¡å‹è‡ªåŠ¨æ·»åŠ ä¸Šå’Œå®ƒç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæœ¬åœ°æ¨¡å‹InternLM2-Chat-7Bã€‚

AlpacaPrompter(å¸¦LLM)



```python
m1 = lazyllm.TrainableModule("internlm2-chat-7b").prompt(prompter1)
res = m1._prompt.generate_prompt({'input':query,'content':passage})
print("\nå¸¦LLMçš„Prompt(Alpaca):\n", repr(res))
```



è¾“å‡ºï¼š



```bash
å¸¦LLMçš„Prompt(Alpaca):
 'You are an AI assistant whose name is InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­).\n- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) is a conversational language model that is developed by Shanghai AI Laboratory (ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤). It is designed to be helpful, honest, and harmless.\n- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) can understand and communicate fluently in the language chosen by the user such as English and ä¸­æ–‡.\nBelow is an instruction that describes a task, paired with extra messages such as input that provides further context if possible. Write a response that appropriately completes the request.\n\n### Instruction:\nç³»ç»ŸæŒ‡ä»¤\n\nç”¨æˆ·æŒ‡ä»¤ã€‚\n### æ–‡æ®µå†…å®¹ï¼šå­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›\n### é—®é¢˜ï¼šå­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ\n### Response:\n'
```

ChatPrompterï¼ˆå¸¦LLMï¼‰

```python
m2 = lazyllm.TrainableModule("internlm2-chat-7b").prompt(prompter2)
res = m2._prompt.generate_prompt({'input':query,'content':passage})
print("\nå¸¦LLMçš„Prompt(Chat):\n", repr(res))
```

è¾“å‡ºï¼š


```bash
å¸¦LLMçš„Prompt(Chat):
 '<|im_start|>system\nYou are an AI assistant whose name is InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­).\n- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) is a conversational language model that is developed by Shanghai AI Laboratory (ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤). It is designed to be helpful, honest, and harmless.\n- InternLM (ä¹¦ç”ŸÂ·æµ¦è¯­) can understand and communicate fluently in the language chosen by the user such as English and ä¸­æ–‡.ç³»ç»ŸæŒ‡ä»¤<|im_end|>\n\n\n\n<|im_start|>user\n\nç”¨æˆ·æŒ‡ä»¤ã€‚\n### æ–‡æ®µå†…å®¹ï¼šå­™æ‚Ÿç©ºï¼Œæ˜¯åœ¨å°è¯´ã€Šè¥¿æ¸¸è®°ã€‹å½“ä¸­å”åƒ§çš„å››ä¸ªå¾’å¼Ÿä¹‹ä¸€ï¼Œæ’è¡Œç¬¬ä¸€ï¼Œåˆ«åå­™è¡Œè€…ã€å­™çŒ´å­ã€‚è‡ªå°ç¾çŒ´ç‹ã€é½å¤©å¤§åœ£ã€‚å› æ›¾åœ¨å¤©åº­æŒç®¡å¾¡é©¬ç›‘è€Œåˆè¢«ç§°ä¸ºå¼¼é©¬æ¸©ï¼Œåœ¨å–ç»å®Œæˆåè¢«å¦‚æ¥ä½›ç¥–æˆå°ä¸ºæ–—æˆ˜èƒœä½›\n### é—®é¢˜ï¼šå­™æ‚Ÿç©ºæœ‰å“ªäº›åå­—ï¼Ÿ\n\n<|im_end|>\n<|im_start|>assistant\n\n'
```



[ç›¸å…³è§†é¢‘ï¼švideo/a2prompt3.mp4](video/a2prompt3.mp4)

æ ¼å¼å¯¹æ¯”ï¼š

|                     | **Alpacaæ ¼å¼**   | **Chatæ ¼å¼**               |
| ---------------------- | ------------------------ | ---------------------------------- |
| **é€‚åˆåœºæ™¯**   | å•è½®é—®ç­”ã€æŒ‡ä»¤å¾®è°ƒ     | å¤šè½®å¯¹è¯ã€å¤æ‚ä»»åŠ¡               |
| **ä¸Šä¸‹æ–‡å¤„ç†** | å•è½®ä»»åŠ¡ã€æ— ä¸Šä¸‹æ–‡è®°å¿† | æ”¯æŒä¸Šä¸‹æ–‡è®°å¿†ã€è¿ç»­å¯¹è¯         |
| **ç»“æ„å¤æ‚åº¦** | ç®€å•                   | çµæ´»å¤šå˜                         |
| **å¯¹è¯è§’è‰²**   | å•è§’è‰²                 | å¤šè§’è‰² (system, user, assistant) |

<br>

|                   | **åœ¨çº¿æ ¼å¼** | **æœ¬åœ°æ ¼å¼**              |
| -------------------- | -------------------- | --------------------------------- |
| **é€‚åˆåœºæ™¯** | è°ƒç ”åœ¨çº¿æ¨¡å‹       | æœ¬åœ°å¯åŠ¨æ¨ç†æœåŠ¡                |
| **æ ¼å¼**     | Json               | å­—ç¬¦ä¸²                          |
| **ç‰¹ç‚¹**     | ä¼šåŒºåˆ†è§’è‰²         | ä¼šåŒ…å«ç‰¹æ®Šæ ‡è®°ï¼Œå¦‚<|im\_start|> |

 ### 4. å¤§æ¨¡å‹å¤šé‡å¤ç”¨ ğŸ§¤

ä¸Šä¸€éƒ¨åˆ†ä»‹ç»äº†å¦‚ä½•è®¾ç½®ç‹¬ç«‹çš„Promptç»™ä¸åŒçš„å¤§æ¨¡å‹ç”¨ã€‚é‚£ä¹ˆå¯ä»¥è®¾ç½®ä¸åŒçš„Promptä½†åº•å±‚å…±ç”¨åŒä¸€ä¸ªå¤§æ¨¡å‹å—ï¼Ÿåœ¨LazyLLMä¸­è¿™ä¸ªå›ç­”æ˜¯è‚¯å®šçš„ï¼å°¤å…¶æ˜¯å¯¹äºæœ¬åœ°çš„æ¨¡å‹ï¼Œè¿™æ ·ä¸ç”¨ä¸ºäº†è®¾ç½®å¤šä¸ªä¸åŒè§’è‰²å¤§æ¨¡å‹è€Œéƒ¨ç½²å¤šä¸ªæœ¬åœ°å¤§æ¨¡å‹ï¼Œè¿›è€Œå¯ä»¥æå¤§åœ°èŠ‚çœæ˜¾å­˜ã€‚

â€‹**ç”¨æ³•1**â€‹ï¼šåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œé€šè¿‡**share**æ¥å®ç°å¤§æ¨¡å‹çš„å…±äº«



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/share_llm_with_prompt.py#L1)

```python
import lazyllm

prompt1 = "ä½ æ‰®æ¼”ä¸€åªå°çŒ«ï¼Œåœ¨æ¯æ¬¡å›ç­”é—®é¢˜éƒ½è¦åŠ ä¸Šï¼šå–µå–µå–µ"
prompt2 = "ä½ æ‰®æ¼”ä¸€åªå°é¸¡ï¼Œåœ¨æ¯æ¬¡å›ç­”é—®é¢˜éƒ½è¦åŠ ä¸Šï¼šå’¯å’¯å“’"

llm = lazyllm.TrainableModule("internlm2-chat-7b")
llm1 = llm.share(prompt=prompt1)
llm2 = llm.share(prompt=prompt2)

# Deploy LLM
llm.start() 

# Show:
inputs = 'ä½ å¥½'
print('æœªè®¾ç½®Promptçš„LLM: ', llm(inputs))
print('è®¾ç½®Prompt1 çš„LLM: ', llm1(inputs))
print('è®¾ç½®Prompt2 çš„LLM: ', llm2(inputs))
```



åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»…éƒ¨ç½²äº†ä¸€ä¸ªå¤§æ¨¡å‹ï¼ˆInternLM2-Chat-7Bï¼‰ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡`share`å¹¶ä¸”åŒæ—¶è®¾ç½®ä¸åŒçš„Promptï¼Œè¿™æ ·å°±æ„å»ºå‡ºå¦å¤–ä¸¤ä¸ªå¸¦æœ‰è§’è‰²çš„å¤§æ¨¡å‹ã€‚è¾“å‡ºæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š



```bash
æœªè®¾ç½®Promptçš„LLM:  ä½ å¥½ï¼æˆ‘æ˜¯ä¹¦ç”ŸÂ·æµ¦è¯­ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
è®¾ç½®Prompt1 çš„LLM:  å–µå–µå–µï¼Œä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
è®¾ç½®Prompt2 çš„LLM:  å’¯å’¯å“’ï¼Œä½ å¥½ï¼æˆ‘æ˜¯ä¹¦ç”ŸÂ·æµ¦è¯­ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚
```


[ç›¸å…³è§†é¢‘ï¼švideo/a3chat1.mp4](video/a3chat1.mp4)

â€‹**ç”¨æ³•2**â€‹ï¼šåœ¨ä¸åŒè¿›ç¨‹ä¸­ï¼Œé€šè¿‡åˆ¶å®š**æ¨ç†æ¡†æ¶**å’Œ**url**æ¥å®ç°å¤§æ¨¡å‹çš„å…±äº«


```python
import lazyllm
m = lazyllm.TrainableModule('internlm2-chat-7b').deploy_method(
    lazyllm.deploy.lightllm, url='http://10.119.17.169:36846/generate')
```



â€‹**å°å½©è›‹**â€‹ï¼šé™¤äº†ç”¨æ³•1åœ¨ä»£ç ä¸­èµ·æ¨ç†æœåŠ¡ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†å‘½ä»¤è¡Œå·¥å…·



```bash
lazyllm deploy internlm2-chat-7b
```


![](3_images/img3.png)

 ### 5. ä¸‰è¡ŒèŠå¤©æœºå™¨äºº ğŸ¤–

ç”¨ LazyLLM æ„é€ ä¸€ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººåªéœ€ä¸‰è¡Œä»£ç ã€‚è¿™é‡Œå¼•å…¥ lazyllm.WebModuleï¼Œå®ƒå¯ä»¥å°†ä»»æ„æ•°æ®æµå°è£…ä¸ºä¸€ä¸ªWebæœåŠ¡ï¼Œè®©æ‚¨å¯ä»¥åœ¨å›¾å½¢ç•Œé¢è¿›è¡Œå¯¹è¯è°ƒè¯•ã€‚



```python
import lazyllm
llm = lazyllm.TrainableModule("internlm2-chat-7b").prompt("ä½ æ‰®æ¼”ä¸€åªå°çŒ«ï¼Œåœ¨æ¯æ¬¡å›ç­”é—®é¢˜éƒ½è¦åŠ ä¸Šå–µå–µå–µ")
webpage = lazyllm.WebModule(llm, port=23466, history=[llm], stream=True).start().wait()
```



ä¸Šé¢ä»£ç ä¸­çš„`WebModule`ï¼š

* æŒ‡å®šç”¨å¤§æ¨¡å‹llmæ¥ä½œä¸ºå¯¹è¯çš„æœºå™¨äºº;
* `port`æŒ‡å®šäº†èŠå¤©ç•Œé¢å‘å¸ƒçš„ç«¯å£ï¼›
* `history`ä¸­æŒ‡å®šäº†è¦å°†llmçš„è¾“å‡ºä½œä¸ºå†å²ä¿¡æ¯ï¼Œè¿™æ ·æœºå™¨äººå°±å…·æœ‰äº†å†å²å¯¹è¯è®°å¿†èƒ½åŠ›ï¼›
* `stream`å¼€å¯äº†è¾“å‡ºçš„å¯¹è¯æ˜¯æµå¼çš„ï¼›
* `start`ç”¨äºå¯åŠ¨æ•´ä¸ªèŠå¤©æœºå™¨äººçš„éƒ¨ç½²ï¼›
* `wait`è¡¨ç¤ºå¯åŠ¨åå°±ä¸€ç›´æœåŠ¡ä¸åœæ­¢ï¼Œå¦‚æœä¸åŠ ä¸ŠæœåŠ¡éƒ¨ç½²å¥½åä¼šç«‹åˆ»åœæ­¢ï¼›

[ç›¸å…³è§†é¢‘ï¼švideo/a3chat2.mp4](video/a3chat2.mp4)

## æ•°æ®æµç®€ä»‹ ğŸ”€

LazyLLMæ˜¯ä¸€æ¬¾ä»¥æ•°æ®æµï¼ˆData Flowï¼‰ä¸ºæ ¸å¿ƒçš„å¤šAgentå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ¡†æ¶ï¼Œæ‰€ä»¥ LazyLLM ä¸­å®šä¹‰äº†å¤§é‡çš„æ•°æ®æµç»„ä»¶ï¼Œé…åˆ LazyLLM ä¸­æä¾›çš„å·¥å…·å’Œç»„ä»¶ï¼Œå¯ä»¥è®©æ‚¨åƒæ­ç§¯æœ¨ä¸€æ ·æ­å»ºå¤æ‚çš„å¤§æ¨¡å‹åº”ç”¨ã€‚æ•°æ®æµçš„æ ¸å¿ƒè®¾è®¡æ€è·¯æ˜¯æ— éœ€æ‚¨æ‰‹åŠ¨å¯¹æ•°æ®æµåŠ¨è¿›è¡ŒæŒ‡å®šï¼Œè€Œæ˜¯é€šè¿‡æ•°æ®æµå†…éƒ¨å°†ä¸Šä¸€é˜¶æ®µçš„æ•°æ®ç›´æ¥åˆ†å‘ç»™å¯¹åº”çš„ä¸‹æ¸¸æ¥æ”¶ç»„ä»¶ã€‚LazyLLMæ”¯æŒPipelineã€Parallelã€Switchã€Ifã€Loopã€Diverterã€Warpã€Graphç­‰æ•°æ®æµã€‚

![image.png](3_images/img4.png)
æœ¬èŠ‚å°†è¯¦ç»†ä¸ºæ‚¨ä»‹ç» LazyLLM ä¸­çš„å„ç§æ•°æ®æµï¼Œæ–¹ä¾¿æ‚¨åœ¨æ¥ä¸‹æ¥çš„æ•™ç¨‹ä¸­ç†è§£å’Œä½¿ç”¨ã€‚

>æ³¨æ„ï¼š
>
>LazyLLM æ”¯æŒæ•°æ®æµçš„ with è¯­å¥ã€‚with è¯­å¥å¯ä»¥è®©æ•°æ®æµå®šä¹‰ä»£ç æ›´åŠ çš„ç®€æ´å’Œæ¸…æ™°ã€‚ä¸‹é¢å…³äºæ•°æ®æµçš„æ‰€æœ‰ä¾‹å­ä¸ä»…å±•ç¤ºäº†åŸºäºå‡½æ•°å¼çš„æ•°æ®æµæ„å»ºï¼ŒåŒæ—¶åœ¨å³ä¾§ä¹Ÿå¯¹åº”å±•ç¤ºäº†é€šè¿‡ with è¯­æ³•å®šä¹‰çš„æ•°æ®æµï¼Œwithè¯­å¥çš„å·§å¦™ä¹‹å¤„åœ¨äºå®šä¹‰ä»£ç çš„ç¼©è¿›ä¸ç›®æ ‡æ•°æ®æµç»“æ„æœ‰ä¸€å®šçš„å…³è”æ€§ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹å‡ºæ•´ä½“ç»“æ„ã€‚

 ### 1. Pipeline

Pipeline æ˜¯é¡ºæ¬¡æ‰§è¡Œçš„æ•°æ®æµï¼Œä¸Šä¸€ä¸ªé˜¶æ®µçš„è¾“å‡ºæˆä¸ºä¸‹ä¸€ä¸ªé˜¶æ®µçš„è¾“å…¥ã€‚pipeline æ”¯æŒå‡½æ•°å’Œä»¿å‡½æ•°ï¼ˆæˆ–ä»¿å‡½æ•°çš„ typeï¼‰ï¼Œå…¶å·¥ä½œæµå¦‚ä¸‹æ‰€ç¤ºï¼š



```bash
input -> module1 -> ... -> moduleN -> out
```


ä¸‹é¢æ˜¯é€šè¿‡ Pipeline æ‰§è¡Œé¡ºåºç»“æ„ç¨‹åºçš„ä¾‹å­, ä»»æ„å‡½æ•°ã€åŒ¿åå‡½æ•°ä»¥åŠå¯è°ƒç”¨å®ä¾‹ï¼ˆå«\_\_call\_\_()å‡½æ•°çš„ç±»ï¼‰éƒ½å¯ä»¥ä½œä¸º pipeline ä¸­çš„ä¸€å‘˜ã€‚

å‡½æ•°å¼ï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/pipeline.py#L1)

```python
import lazyllm

f1 = lambda x: x * 2

def f2(input):
  return input - 1

class AddOneFunctor(object):
  def __call__(self, x): return x + 1

f3 = AddOneFunctor()

# æ‰‹åŠ¨è°ƒç”¨ï¼š
inp = 2
x1 = f1(inp)
x2 = f2(x1)
x3 = f3(x2)
out_normal = AddOneFunctor()(x3)

# ä½¿ç”¨æ•°æ®æµ
ppl = lazyllm.pipeline(f1, f2, f3, AddOneFunctor)
out_ppl1 = ppl(inp)

print(f"è¾“å…¥ä¸º{inp},æ‰‹åŠ¨è°ƒç”¨è¾“å‡º:", out_normal)
print(f"è¾“å…¥ä¸º{inp},æ•°æ®æµè¾“å‡º:", out_ppl1)

```



è¾“å‡ºï¼š

```bash
è¾“å…¥ä¸º2,æ‰‹åŠ¨è°ƒç”¨è¾“å‡º: 5
è¾“å…¥ä¸º2,æ•°æ®æµè¾“å‡º: 5
```

withå¼ï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/pipeline_with.py#L1)

```python
import lazyllm

f1 = lambda x: x * 2

def f2(input):
  return input - 1

class AddOneFunctor(object):
  def __call__(self, x): return x + 1

f3 = AddOneFunctor()

# ä½¿ç”¨withæ–¹å¼çš„æ•°æ®æµ
with lazyllm.pipeline() as ppl:
    ppl.func1 = f1
    ppl.func2 = f2
    ppl.func3 = f3
    ppl.func4 = AddOneFunctor

inp = 2
out_ppl1 = ppl(inp)

print(f"è¾“å…¥ä¸º{inp},æ•°æ®æµè¾“å‡º:", out_ppl1)
```



è¾“å‡ºï¼š

```bash
è¾“å…¥ä¸º2,æ•°æ®æµè¾“å‡º: 5
```

[ç›¸å…³è§†é¢‘ï¼švideo/1pipeline.mp4](video/1pipeline.mp4)

[ç›¸å…³è§†é¢‘ï¼švideo/1pipeline_with.mp4](video/1pipeline_with.mp4)

 ### 2. Parallel

Parallelæ”¯æŒæˆ‘ä»¬å¹¶è¡Œè°ƒç”¨å¤šä¸ªpipelineï¼Œå…¶æ•°æ®æµç¤ºæ„å¦‚ä¸‹ï¼š



```bash
      /> module11 -> ... -> module1N -> out1 \
input ->  module21 -> ... -> module2N -> out2 -> (out1, out2, out3)
      \> module31 -> ... -> module3N -> out3 /
```



Parallelæ”¯æŒå¯¹è¾“å‡ºæ ¼å¼è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ï¼Œæ–¹ä¾¿ä¸‹æ¸¸ç»„ä»¶è¿›è¡Œé’ˆå¯¹æ€§ä½¿ç”¨ï¼Œç›®å‰Parallelæ”¯æŒè¾“å‡ºå­—å…¸ã€å…ƒç»„ã€åˆ—è¡¨å’Œå­—ç¬¦ä¸²å½¢å¼çš„è¾“å‡ºï¼Œå…·ä½“æ•ˆæœå¯è§ä¸‹æ–¹ä¾‹å­ï¼š

å‡½æ•°å¼ï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/parallel.py#L1)

```python
import lazyllm

test1 = lambda a: a + 1
test2 = lambda a: a * 4
test3 = lambda a: a / 2

prl1 = lazyllm.parallel(test1, test2, test3)
prl2 = lazyllm.parallel(path1=test1, path2=test2, path3=test3).asdict
prl3 = lazyllm.parallel(test1, test2, test3).astuple
prl4 = lazyllm.parallel(test1, test2, test3).aslist
prl5 = lazyllm.parallel(test1, test2, test3).join('ï¼Œ')

print("é»˜è®¤è¾“å‡ºï¼šprl1(1) -> ", prl1(1), type(prl1(1)))
print("è¾“å‡ºå­—å…¸ï¼šprl2(1) -> ", prl2(1), type(prl2(1)))
print("è¾“å‡ºå…ƒç»„ï¼šprl3(1) -> ", prl3(1), type(prl3(1)))
print("è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) -> ", prl4(1), type(prl4(1)))
print("è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) -> ", prl5(1), type(prl5(1)))
```



è¾“å‡ºï¼š



```bash
é»˜è®¤è¾“å‡ºï¼šprl1(1) ->  (2, 4, 0.5) <class 'lazyllm.common.common.package'>
è¾“å‡ºå­—å…¸ï¼šprl2(1) ->  {'path1': 2, 'path2': 4, 'path3': 0.5} <class 'dict'>
è¾“å‡ºå…ƒç»„ï¼šprl3(1) ->  (2, 4, 0.5) <class 'tuple'>
è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) ->  [2, 4, 0.5] <class 'list'>
è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) ->  2ï¼Œ4ï¼Œ0.5 <class 'str'>
```

withå¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/parallel_with.py#L1)ï¼‰ï¼š

```python
import lazyllm

test1 = lambda a: a + 1
test2 = lambda a: a * 4
test3 = lambda a: a / 2

with lazyllm.parallel() as prl1:
    prl1.func1 = test1
    prl1.func2 = test2
    prl1.func3 = test3

with lazyllm.parallel().asdict as prl2:
    prl2.path1 = test1
    prl2.path2 = test2
    prl2.path3 = test3

with lazyllm.parallel().astuple as prl3:
    prl3.func1 = test1
    prl3.func2 = test2
    prl3.func3 = test3

with lazyllm.parallel().aslist as prl4:
    prl4.func1 = test1
    prl4.func2 = test2
    prl4.func3 = test3

with lazyllm.parallel().join('ï¼Œ') as prl5:
    prl5.func1 = test1
    prl5.func2 = test2
    prl5.func3 = test3

print("é»˜è®¤è¾“å‡ºï¼šprl1(1) -> ", prl1(1), type(prl1(1)))
print("è¾“å‡ºå­—å…¸ï¼šprl2(1) -> ", prl2(1), type(prl2(1)))
print("è¾“å‡ºå…ƒç»„ï¼šprl3(1) -> ", prl3(1), type(prl3(1)))
print("è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) -> ", prl4(1), type(prl4(1)))
print("è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) -> ", prl5(1), type(prl5(1)))
```



è¾“å‡ºï¼š



```bash
é»˜è®¤è¾“å‡ºï¼šprl1(1) ->  (2, 4, 0.5) <class 'lazyllm.common.common.package'>
è¾“å‡ºå­—å…¸ï¼šprl2(1) ->  {'path1': 2, 'path2': 4, 'path3': 0.5} <class 'dict'>
è¾“å‡ºå…ƒç»„ï¼šprl3(1) ->  (2, 4, 0.5) <class 'tuple'>
è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) ->  [2, 4, 0.5] <class 'list'>
è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) ->  2ï¼Œ4ï¼Œ0.5 <class 'str'>
```

[ç›¸å…³è§†é¢‘ï¼švideo/2parallel.mp4](video/2parallel.mp4)

[ç›¸å…³è§†é¢‘ï¼švideo/2parallel_with.mp4](video/2parallel_with.mp4)


 ### 3. Diverter

Diverteræ˜¯ä¸€ç§ä¸“é—¨çš„å¹¶è¡Œå¤„ç†å·¥å…·ï¼Œå…¶ä¸­å¤šä¸ªè¾“å…¥åˆ†åˆ«é€šè¿‡ä¸€ç³»åˆ—å¹¶è¡Œçš„æ¨¡å—ã€‚ç„¶åå°†è¾“å‡ºèšåˆè¿”å›ã€‚



```bash
#                 /> in1 -> module11 -> ... -> module1N -> out1 \
# (in1, in2, in3) -> in2 -> module21 -> ... -> module2N -> out2 -> (out1, out2, out3)
#                 \> in3 -> module31 -> ... -> module3N -> out3 /
```



å½“æ‚¨æ‹¥æœ‰å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ä¸åŒæ•°æ®å¤„ç†ç®¡é“ï¼Œå¹¶å¸Œæœ›åœ¨å•ä¸ªæµæ„é€ ä¸­ç®¡ç†å®ƒä»¬æ—¶ï¼Œè¯¥å·¥å…·éå¸¸æœ‰ç”¨ã€‚å’ŒParallelä¸€æ ·ï¼Œè¯¥å·¥å…·æ”¯æŒå¯¹è¾“å‡ºæ ¼å¼è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ï¼Œç›®å‰æ”¯æŒè¾“å‡ºå­—å…¸ã€å…ƒç»„ã€åˆ—è¡¨å’Œå­—ç¬¦ä¸²å½¢å¼çš„è¾“å‡ºï¼Œå…·ä½“æ•ˆæœå¯è§ä¸‹æ–¹ä¾‹å­ï¼š

å‡½æ•°å¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/diverter.py#L1)ï¼‰ï¼š



```python
import lazyllm

test1 = lambda a: a + 1
test2 = lambda a: a * 4
test3 = lambda a: a / 2

prl1 = lazyllm.diverter(test1, test2, test3)
prl2 = lazyllm.diverter(path1=test1, path2=test2, path3=test3).asdict
prl3 = lazyllm.diverter(test1, test2, test3).astuple
prl4 = lazyllm.diverter(test1, test2, test3).aslist
prl5 = lazyllm.diverter(test1, test2, test3).join('ï¼Œ')

inputs = [1, 2, 3]

print("é»˜è®¤è¾“å‡ºï¼šprl1(1) -> ", prl1(inputs), type(prl1(inputs)))
print("è¾“å‡ºå­—å…¸ï¼šprl2(1) -> ", prl2(inputs), type(prl2(inputs)))
print("è¾“å‡ºå…ƒç»„ï¼šprl3(1) -> ", prl3(inputs), type(prl3(inputs)))
print("è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) -> ", prl4(inputs), type(prl4(inputs)))
print("è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) -> ", prl5(inputs), type(prl5(inputs)))
```



è¾“å‡ºï¼š



```bash
é»˜è®¤è¾“å‡ºï¼šprl1(1) ->  (2, 8, 1.5) <class 'lazyllm.common.common.package'>
è¾“å‡ºå­—å…¸ï¼šprl2(1) ->  {'path1': 2, 'path2': 8, 'path3': 1.5} <class 'dict'>
è¾“å‡ºå…ƒç»„ï¼šprl3(1) ->  (2, 8, 1.5) <class 'tuple'>
è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) ->  [2, 8, 1.5] <class 'list'>
è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) ->  2ï¼Œ8ï¼Œ1.5 <class 'str'>
```

withå¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/diverter_with.py#L1)ï¼‰ï¼š

```python
import lazyllm

test1 = lambda a: a + 1
test2 = lambda a: a * 4
test3 = lambda a: a / 2

with lazyllm.diverter() as prl1:
    prl1.func1 = test1
    prl1.func2 = test2
    prl1.func3 = test3

with lazyllm.diverter().asdict as prl2:
    prl2.func1 = test1
    prl2.func2 = test2
    prl2.func3 = test3

with lazyllm.diverter().astuple as prl3:
    prl3.func1 = test1
    prl3.func2 = test2
    prl3.func3 = test3

with lazyllm.diverter().aslist as prl4:
    prl4.func1 = test1
    prl4.func2 = test2
    prl4.func3 = test3

with lazyllm.diverter().join('ï¼Œ') as prl5:
    prl5.func1 = test1
    prl5.func2 = test2
    prl5.func3 = test3

inputs = [1, 2, 3]

print("é»˜è®¤è¾“å‡ºï¼šprl1(1) -> ", prl1(inputs), type(prl1(inputs)))
print("è¾“å‡ºå­—å…¸ï¼šprl2(1) -> ", prl2(inputs), type(prl2(inputs)))
print("è¾“å‡ºå…ƒç»„ï¼šprl3(1) -> ", prl3(inputs), type(prl3(inputs)))
print("è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) -> ", prl4(inputs), type(prl4(inputs)))
print("è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) -> ", prl5(inputs), type(prl5(inputs)))
```



è¾“å‡ºï¼š



```bash
é»˜è®¤è¾“å‡ºï¼šprl1(1) ->  (2, 8, 1.5) <class 'lazyllm.common.common.package'>
è¾“å‡ºå­—å…¸ï¼šprl2(1) ->  {'func1': 2, 'func2': 8, 'func3': 1.5} <class 'dict'>
è¾“å‡ºå…ƒç»„ï¼šprl3(1) ->  (2, 8, 1.5) <class 'tuple'>
è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) ->  [2, 8, 1.5] <class 'list'>
è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) ->  2ï¼Œ8ï¼Œ1.5 <class 'str'>
```



[ç›¸å…³è§†é¢‘ï¼švideo/3diverter.mp4](video/3diverter.mp4)

[ç›¸å…³è§†é¢‘ï¼švideo/3diverter_with.mp4](video/3diverter_with.mp4)


 ### 4. Warp

Warpæ˜¯ä¸€æ¬¾å¼ºå¤§çš„æ§åˆ¶æµå·¥å…·ï¼Œæ—¨åœ¨å°†åŒä¸€å¤„ç†æ¨¡å—å¹¶è¡Œåœ°åº”ç”¨äºä¸€ç³»åˆ—è¾“å…¥æ•°æ®ã€‚å®ƒé€šè¿‡é«˜æ•ˆåœ°â€œå½¢å˜â€å•ä¸ªæ¨¡å—è‡³å„ä¸ªè¾“å…¥ï¼Œç¡®ä¿æ¯ä¸ªè¾“å…¥éƒ½èƒ½å¾—åˆ°å¹¶è¡Œå¤„ç†ï¼Œä»è€Œå¤§å¹…æå‡å¤„ç†æ•ˆç‡ã€‚

å·¥ä½œåŸç†ç¤ºæ„å›¾ï¼š



```bash
#                 /> in1 \                            /> out1 \
# (in1, in2, in3) -> in2 -> module1 -> ... -> moduleN -> out2 -> (out1, out2, out3)
#                 \> in3 /                            \> out3 /
```

>â€‹**æ³¨æ„**â€‹ï¼š
>
>* Warpæµä¸åº”ç”¨äºå¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚è®­ç»ƒå’Œéƒ¨ç½²ã€‚
>* Warpæµä¸æ”¯æŒå­—å…¸è¾“å‡º

ä¸Parallelå·¥å…·ç±»ä¼¼ï¼ŒWarpæ”¯æŒå¯¹è¾“å‡ºæ ¼å¼è¿›è¡Œçµæ´»å¤„ç†ã€‚ç›®å‰ï¼Œå®ƒèƒ½å¤Ÿè¾“å‡ºå…ƒç»„ã€åˆ—è¡¨å’Œå­—ç¬¦ä¸²å½¢å¼çš„ç»“æœè¾“å‡ºï¼ˆæ³¨æ„ï¼šæš‚ä¸æ”¯æŒå­—å…¸è¾“å‡ºï¼‰ã€‚å…·ä½“çš„æ ¼å¼åŒ–æ•ˆæœåŠç¤ºä¾‹ï¼Œè¯·å‚è§ä¸‹æ–¹ä¾‹å­ï¼š

å‡½æ•°å¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/warp.py#L1)ï¼‰ï¼š



```python
import lazyllm

test1 = lambda a: a + 1
test2 = lambda a: a * 4
test3 = lambda a: a / 2

prl1 = lazyllm.warp(test1, test2, test3)
# prl2 = lazyllm.warp(path1=test1, path2=test2, path3=test3).asdict # Not Implemented
prl3 = lazyllm.warp(test1, test2, test3).astuple
prl4 = lazyllm.warp(test1, test2, test3).aslist
prl5 = lazyllm.warp(test1, test2, test3).join('ï¼Œ')

inputs = [1, 2, 3]

print("é»˜è®¤è¾“å‡ºï¼šprl1(1) -> ", prl1(inputs), type(prl1(inputs)))
print("è¾“å‡ºå…ƒç»„ï¼šprl3(1) -> ", prl3(inputs), type(prl3(inputs)))
print("è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) -> ", prl4(inputs), type(prl4(inputs)))
print("è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) -> ", prl5(inputs), type(prl5(inputs)))
```



è¾“å‡ºï¼š



```bash
é»˜è®¤è¾“å‡ºï¼šprl1(1) ->  (4.0, 6.0, 8.0) <class 'lazyllm.common.common.package'>
è¾“å‡ºå…ƒç»„ï¼šprl3(1) ->  (4.0, 6.0, 8.0) <class 'tuple'>
è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) ->  [4.0, 6.0, 8.0] <class 'list'>
è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) ->  4.0ï¼Œ6.0ï¼Œ8.0 <class 'str'>
```

withå¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/warp_with.py#L1)ï¼‰ï¼š

```python
import lazyllm

test1 = lambda a: a + 1
test2 = lambda a: a * 4
test3 = lambda a: a / 2

with lazyllm.warp() as prl1:
    prl1.func1 = test1
    prl1.func2 = test2
    prl1.func3 = test3

with lazyllm.warp().astuple as prl3:
    prl3.func1 = test1
    prl3.func2 = test2
    prl3.func3 = test3

with lazyllm.warp().aslist as prl4:
    prl4.func1 = test1
    prl4.func2 = test2
    prl4.func3 = test3

with lazyllm.warp().join('ï¼Œ') as prl5:
    prl5.func1 = test1
    prl5.func2 = test2
    prl5.func3 = test3

inputs = [1, 2, 3]

print("é»˜è®¤è¾“å‡ºï¼šprl1(1) -> ", prl1(inputs), type(prl1(inputs)))
print("è¾“å‡ºå…ƒç»„ï¼šprl3(1) -> ", prl3(inputs), type(prl3(inputs)))
print("è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) -> ", prl4(inputs), type(prl4(inputs)))
print("è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) -> ", prl5(inputs), type(prl5(inputs)))
```



è¾“å‡ºï¼š



```bash
é»˜è®¤è¾“å‡ºï¼šprl1(1) ->  (4.0, 6.0, 8.0) <class 'lazyllm.common.common.package'>
è¾“å‡ºå…ƒç»„ï¼šprl3(1) ->  (4.0, 6.0, 8.0) <class 'tuple'>
è¾“å‡ºåˆ—è¡¨ï¼šprl4(1) ->  [4.0, 6.0, 8.0] <class 'list'>
è¾“å‡ºå­—ç¬¦ä¸²ï¼šprl5(1) ->  4.0ï¼Œ6.0ï¼Œ8.0 <class 'str'>
```



[ç›¸å…³è§†é¢‘ï¼švideo/4warp.mp4](video/4warp.mp4)

[ç›¸å…³è§†é¢‘ï¼švideo/4warp_with.mp4](video/4warp_with.mp4)


 ### 5. IFS

IFSæ˜¯LazyLLMæ¡†æ¶ä¸­å®ç°çš„If-ElseåŠŸèƒ½ï¼Œå¯æ ¹æ®æ¡ä»¶è¯„ä¼°ç»“æœé€‰æ‹©æ‰§è¡Œä¸¤æ¡è·¯å¾„ä¹‹ä¸€ï¼ˆæ¡ä»¶ä¸ºçœŸçš„è·¯å¾„æˆ–æ¡ä»¶åˆ¤æ–­ä¸ºå‡çš„è·¯å¾„ï¼‰ã€‚IFSä½¿ç”¨withè¯­å¥æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œä»…å±•ç¤ºå‡½æ•°å¼çš„ä½¿ç”¨ï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/ifs.py#L1)

```python
import lazyllm

cond = lambda x: x > 0
true_path = lambda x: x * 2
false_path = lambda x: -x

ifs_flow = lazyllm.ifs(cond, true_path, false_path)

res1 = ifs_flow(10)
print('è¾“å…¥ï¼š10ï¼Œè¾“å‡ºï¼š', res1)
res2 = ifs_flow(-5)
print('è¾“å…¥ï¼š-5ï¼Œè¾“å‡ºï¼š', res2)
```



è¾“å‡ºï¼š



```bash
è¾“å…¥: 10,è¾“å‡ºï¼š 20
è¾“å…¥ï¼š-5,è¾“å‡ºï¼š 5
```



[ç›¸å…³è§†é¢‘ï¼švideo/5ifs.mp4](video/5ifs.mp4)


 ### 6. Switch

Switchæ•°æ®æµå·¥å…·æä¾›äº†ä¸€ç§æ ¹æ®è¡¨è¾¾å¼çš„å€¼æˆ–æ¡ä»¶çš„çœŸå®æ€§æ¥é€‰æ‹©ä¸åŒæµçš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å®ƒç±»ä¼¼äºå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­çš„switch-caseè¯­å¥ã€‚

ç”¨æˆ·åœ¨ä½¿ç”¨è¯¥æ§åˆ¶æµå·¥å…·çš„è¿‡ç¨‹ä¸­éœ€è¦å®šä¹‰å¥½æ¡ä»¶æ§åˆ¶å‡½æ•°condï¼ŒåŠå…¶å¯¹åº”çš„åˆ†æ”¯å‡½æ•°moduleXï¼ˆå¯ä»¥æ˜¯å…¶ä»–çš„æ§åˆ¶æµï¼Œå¦‚ï¼šPipelineç­‰ï¼‰ã€‚å…¶ä¸­æœ‰ä¸ªç‰¹æ®Šçš„æ¡ä»¶æ§åˆ¶å‡½æ•°å¯ä»¥ç›´æ¥è®¾ç½®ä¸ºå­—ç¬¦ä¸²`default`æ¥ä½œä¸ºå…œåº•çš„é»˜è®¤åˆ†æ”¯ã€‚

å·¥ä½œåŸç†ç¤ºæ„å›¾ï¼š



```bash
# switch(exp):
#     case cond1: input -> module11 -> ... -> module1N -> out; break
#     case cond2: input -> module21 -> ... -> module2N -> out; break
#     case cond3: input -> module31 -> ... -> module3N -> out; break
```



å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯Switchä¸­æœ‰ä¸€ä¸ªå«åš`judge_on_full_input`çš„å‚æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹è¯¥å‚æ•°ä¸ºTrueï¼Œè¿™æ„å‘³ç€æ¯æ¬¡è¾“å…¥åˆ°Switchä¸­çš„æ•°æ®éƒ½ä¼šåŒæ—¶ä½œä¸ºæ¡ä»¶æ§åˆ¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼›å¦‚æœè¯¥å‚æ•°è®¾ç½®ä¸ºFalseï¼Œè¿™æ„å‘³ç€è‡³å°‘éœ€è¦ä¸¤ä¸ªè¾“å…¥ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªä¼šä½œä¸ºæ¡ä»¶æ§åˆ¶å‡½æ•°çš„è¾“å…¥ï¼Œå‰©ä¸‹çš„ä¼šä½œä¸ºåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ã€‚å…·ä½“ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š

å‡½æ•°å¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/switch.py#L1)ï¼‰ï¼š



```python
import lazyllm

# æ¡ä»¶å‡½æ•°
is_positive = lambda x: x > 0
is_negative = lambda x: x < 0

# æ¯ä¸ªæ¡ä»¶å‡½æ•°å¯¹åº”ä¸€ä¸ªåˆ†æ”¯å‡½æ•°ï¼š
positive_path = lambda x: 2 * x
negative_path = lambda x : -x
default_path = lambda x : '000'

# switchæ„å»º1ï¼ˆxåŒæ—¶ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼‰ï¼š
switch1 = lazyllm.switch(
    is_positive, positive_path,
    is_negative, negative_path,
    'default', default_path)

# Show:
print('\nè¾“å…¥xåŒæ—¶ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š')
print("1Path Positive: ", switch1(2)) # 2ä¸ä»…ä¼ å…¥æ¡ä»¶å‡½æ•°ï¼Œ2ä¹Ÿä¼ å…¥å¯¹åº”çš„åˆ†æ”¯å‡½æ•°ï¼›
print("1Path Default:  ", switch1(0))
print("1Path Negative: ", switch1(-5))

# switchæ„å»º2ï¼ˆæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥æŒ‡å®šä¸åŒçš„å€¼ï¼‰ï¼š
switch2 = lazyllm.switch(
    is_positive, positive_path,
    is_negative, negative_path,
    'default', default_path,
    judge_on_full_input=False)

# Show:
print('\nè¾“å…¥x,yæŒ‰ä½ç½®åˆ†åˆ«ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š')
print("2Path Positive: ", switch2(-1,2)) # -1ä¼ å…¥æ¡ä»¶å‡½æ•°ï¼Œ2ä¼ å…¥å¯¹åº”åˆ†æ”¯å‡½æ•°ï¼›
print("2Path Default:  ", switch2(1,2))
print("2Path Negative: ", switch2(0, 2))
```



è¾“å‡ºï¼š



```bash
è¾“å…¥xåŒæ—¶ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š
1Path Positive:  4
1Path Default:   000
1Path Negative:  5

è¾“å…¥x,yæŒ‰ä½ç½®åˆ†åˆ«ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š
2Path Positive:  -2
2Path Default:   4
2Path Negative:  000
```

withå¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/switch_with.py#L1)ï¼‰ï¼š



```python
import lazyllm

# æ¡ä»¶å‡½æ•°
is_positive = lambda x: x > 0
is_negative = lambda x: x < 0

# æ¯ä¸ªæ¡ä»¶å‡½æ•°å¯¹åº”ä¸€ä¸ªåˆ†æ”¯å‡½æ•°ï¼š
positive_path = lambda x: 2 * x
negative_path = lambda x : -x
default_path = lambda x : '000'

# switchæ„å»º1ï¼ˆxåŒæ—¶ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼‰ï¼š
with lazyllm.switch() as sw1:
    sw1.case(is_positive, positive_path)
    sw1.case(is_negative, negative_path)
    sw1.case('default', default_path)

# Show:
print('\nè¾“å…¥xåŒæ—¶ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š')
print("1Path Positive: ", sw1(2)) # 2ä¸ä»…ä¼ å…¥æ¡ä»¶å‡½æ•°ï¼Œ2ä¹Ÿä¼ å…¥å¯¹åº”çš„åˆ†æ”¯å‡½æ•°ï¼›
print("1Path Default:  ", sw1(0))
print("1Path Negative: ", sw1(-5))

# switchæ„å»º2ï¼ˆæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥æŒ‡å®šä¸åŒçš„å€¼ï¼‰ï¼š
with lazyllm.switch(judge_on_full_input=False) as sw2:  # åˆ†ç¦»æ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„å…³é”®å¼€å…³ã€‚æ³¨æ„é»˜è®¤æ˜¯True
    sw2.case(is_positive, positive_path)
    sw2.case(is_negative, negative_path)
    sw2.case('default', default_path)

# Show:
print('\nè¾“å…¥x,yæŒ‰ä½ç½®åˆ†åˆ«ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š')
print("2Path Positive: ", sw2(-1,2)) # -1ä¼ å…¥æ¡ä»¶å‡½æ•°ï¼Œ2ä¼ å…¥å¯¹åº”åˆ†æ”¯å‡½æ•°ï¼›
print("2Path Default:  ", sw2(1,2))
print("2Path Negative: ", sw2(0, 2))
```



è¾“å‡ºï¼š



```bash
è¾“å…¥xåŒæ—¶ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š
1Path Positive:  4
1Path Default:   000
1Path Negative:  5

è¾“å…¥x,yæŒ‰ä½ç½®åˆ†åˆ«ä½œä¸ºæ¡ä»¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼š
2Path Positive:  -2
2Path Default:   4
2Path Negative:  000
```



[ç›¸å…³è§†é¢‘ï¼švideo/6switch.mp4](video/6switch.mp4)

[ç›¸å…³è§†é¢‘ï¼švideo/6swich_with.mp4](video/6swich_with.mp4)


 ### 7. Loop

Loopæ˜¯ä¸€ä¸ªå¾ªç¯æ§åˆ¶æµå·¥å…·ï¼Œå¯ä»¥å°†ä¸€ç³»åˆ—å‡½æ•°é‡å¤åº”ç”¨äºè¾“å…¥ï¼Œç›´åˆ°æ»¡è¶³åœæ­¢æ¡ä»¶æˆ–è¾¾åˆ°æŒ‡å®šçš„è¿­ä»£æ¬¡æ•°ã€‚Loopç»“æ„å…è®¸å®šä¹‰ä¸€ä¸ªç®€å•çš„æ§åˆ¶æµï¼Œå…¶ä¸­ä¸€ç³»åˆ—æ­¥éª¤åœ¨å¾ªç¯ä¸­åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨å¯é€‰çš„åœæ­¢æ¡ä»¶æ¥æ ¹æ®æ­¥éª¤çš„è¾“å‡ºé€€å‡ºå¾ªç¯ã€‚

Loopä¸­æœ‰ä¸ªå«`judge_on_full_input`çš„å‚æ•°ï¼Œé»˜è®¤æƒ…å†µè¯¥å€¼ä¸ºTrueï¼Œè¿™æ„å‘³ç€ï¼Œè¾“å‡ºçš„å®Œæ•´ç»“æœä¼šè¢«ä½œä¸ºæ¡ä»¶æ§åˆ¶å‡½æ•°å’Œåˆ†æ”¯å‡½æ•°çš„è¾“å…¥ï¼›å¦‚æœè¯¥å€¼ä¸ºFalseï¼Œé‚£ä¹ˆè¾“å‡ºçš„ç»“æœä¼šè¢«åˆ‡åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¼šä½œä¸ºæ¡ä»¶æ§åˆ¶å‡½æ•°çš„è¾“å…¥ï¼Œå‰©ä¸‹éƒ¨åˆ†ä½œä¸ºä¸‹æ¬¡å¾ªç¯çš„è¾“å‡ºã€‚æ‰€ä»¥å½“ä¸»åŠ¨è®¾ç½®è¯¥å‚æ•°ä¸ºFalseæ—¶å€™è¦æ³¨æ„ï¼Œåˆ†æ”¯å‡½æ•°éœ€è¦è¿”å›è‡³å°‘ä¸¤ä¸ªå€¼ï¼Œç¬¬ä¸€ä¸ªå€¼ä½œä¸ºæ¡ä»¶è¾“å…¥ï¼Œç¬¬äºŒä¸ªå€¼ä½œä¸ºä¸‹æ¬¡å¾ªç¯çš„è¾“å…¥ã€‚å¦‚ä¸‹é¢ä¾‹å­ä¸­æ‰€ç¤ºï¼š

å‡½æ•°å¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/loop.py#L1)ï¼‰ï¼š



```python
import lazyllm

# æ¡ä»¶å‡½æ•°
stop_func = lambda x: x > 10

# åˆ†æ”¯å‡½æ•°
module_func = lambda x: x * 2

# loopæ„å»º1
loop1 = lazyllm.loop(
    module_func,
    stop_condition=stop_func)

# Show:
print('1è¾“å‡ºï¼š', loop1(1))

#==========================
# åˆ†æ”¯å‡½æ•°2
def module_func2(x):
    print("\tloop: ", x)
    return lazyllm.package(x+1, x*2)

# loopæ„å»º2
loop2 = lazyllm.loop(
    module_func2,
    stop_condition=stop_func,
    judge_on_full_input=False)

# Show:
print('2è¾“å‡ºï¼š', loop2(1))
```



è¾“å‡ºï¼š



```bash
1è¾“å‡ºï¼š 16
        loop:  1
        loop:  2
        loop:  4
        loop:  8
        loop:  16
2è¾“å‡ºï¼š (32,)
```

withå¼ï¼ˆ[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/loop_with.py#L1)ï¼‰ï¼š

```python
import lazyllm

# æ¡ä»¶å‡½æ•°
stop_func = lambda x: x > 10

# åˆ†æ”¯å‡½æ•°
module_func = lambda x: x
modele_func2 = lambda x: x * 2

# loopæ„å»º
with lazyllm.loop(stop_condition=stop_func) as loop1:
    loop1.func1 = module_func
    loop1.func2 = modele_func2

# Show:
print('è¾“å‡ºï¼š', loop1(1))

#==========================
# åˆ†æ”¯å‡½æ•°2
def module_funcn2(x):
    print("\tloop: ", x)
    return lazyllm.package(x+1, x*2)

# loopæ„å»º2
with lazyllm.loop(stop_condition=stop_func, judge_on_full_input=False) as loop2:
    loop2.func1 = module_func
    loop2.func2 = module_funcn2

# Show:
print('2è¾“å‡ºï¼š', loop2(1))
```



è¾“å‡ºï¼š



```bash
è¾“å‡ºï¼š 16
        loop:  1
        loop:  2
        loop:  4
        loop:  8
        loop:  16
2è¾“å‡ºï¼š (32,)
```



[ç›¸å…³è§†é¢‘ï¼švideo/7loop.mp4](video/7loop.mp4)

[ç›¸å…³è§†é¢‘ï¼švideo/7loop_with.mp4](video/7loop_with.mp4)


 ### 8. Bind

é€šè¿‡ä¸Šè¿°å¯¹æ•°æ®æµçš„ä»‹ç»ï¼Œæˆ‘ä»¬ä¼šå‘ç°æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æ•°æ®æŒ‰ç…§é¢„å®šä¹‰çš„è·¯å¾„æµåŠ¨ï¼Œæˆ‘ä»¬ä¼¼ä¹åªèƒ½æ§åˆ¶å…¥ç«¯æ•°æ®ï¼Œå½“æˆ‘ä»¬é‡åˆ°æƒ³è¦åœ¨æŸä¸ªç¯èŠ‚å¼•å…¥ä¸Šä¸¤çº§çš„æ•°æ®æ—¶å°±ä¼šé‡åˆ°é—®é¢˜ï¼Œå¦‚ä¸‹é¢å›¾ç¤ºä¸­çš„inåˆ°f3æˆ‘ä»¬å¾ˆéš¾ç”¨ä¸Šè¿°çš„æµæ¥æ­å»ºã€‚

![image.png](3_images/img5.png)

é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒLazyLLM æä¾›äº†ä¸€ç§å‚æ•°ç»‘å®šçš„æ–¹å¼ï¼Œä½¿æ•°æ®åœ¨æ•°æ®æµä¸­å‘ä¸‹æ¸¸è‡ªç”±åœ°æ¸¸èµ°ï¼ˆè·³è·ƒçš„æ•°æ®æµï¼‰ã€‚

è®©æˆ‘ä»¬å…ˆå®šä¹‰f1,f21,f22,f3ä¸Šå›¾ä¸­çš„å‡ ä¸ªå‡½æ•°ï¼š



```python
def f1(input): return input ** 2
def f21(input1, input2=0): return input1 + input2 + 1
def f22(input1, input2=0): return input1 + input2 - 1
def f3(in1='placeholder1', in2='placeholder2', in3='placeholder3'): 
    return f'get [input:{in1}], [f21:{in2}], [f23: {in3}]]'
```


LazyLLM æä¾›äº† lazyllm.bind å‡½æ•°è¿›è¡Œå‡½æ•°ç»‘å®šï¼Œbind å‡½æ•°æ¥æ”¶çš„å‚æ•°æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š



```text
lazyllm.bind(func, param1, param2, ...)
```



å…¶ä¸­ï¼š

* `func` ä¸ºéœ€è¦è¿›è¡Œå‚æ•°ç»‘å®šçš„å‡½æ•°ï¼Œ
* `param1`, `param2` ä¾æ¬¡ä¸º `func` æ¥æ”¶çš„å‚æ•°ã€‚å®é™…ä¸Šæˆ‘ä»¬è§‚å¯Ÿä¸Šå›¾å¯ä»¥å‘ç°ï¼š
  * æˆ‘ä»¬éœ€è¦è¾“å…¥çš„`param1`å°±æ˜¯pplçš„è¾“å…¥ï¼ˆppl.inputï¼‰ï¼Œæ­¤å¤„æˆ‘ä»¬å¯ä»¥é€šè¿‡ ppl.input åœ¨å½“å‰æ•°æ®æµè·å–å¯¹åº”çš„è¾“å…¥ã€‚
  * `param2` å’Œ `param3` æ˜¯f3çš„ä¸Šä¸€çº§ï¼ŒLazyLLMå¯¹è¿™ç§æƒ…å†µå®šä¹‰äº†ä¸€ç§å ä½ç¬¦ï¼Œ\_0ã€‚\_0è¡¨ç¤ºæ•°æ®æµä¸­å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€çº§è¾“å‡ºï¼Œå¦‚æœä¸Šä¸€çº§ä¸­æœ‰å¤šä¸ªè¾“å‡ºï¼Œåˆ™å¯ä»¥é€šè¿‡\_1, \_2, \_3ä¾æ¬¡è·å–ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªè¾“å‡ºæ‰€ä»¥åˆ†åˆ«æ˜¯\_0, \_1ã€‚

åŸºäºLazyLLMçš„å‚æ•°ç»‘å®šå¯ä»¥å®ç°ä¸Šå›¾ä¸­çš„æ•°æ®è·³è¿ï¼š



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/bind.py#L1)

```python
from lazyllm import pipeline, parallel, bind, _0, _1

with pipeline() as ppl1:
  ppl1.f1 = f1
  with parallel() as ppl1.subprl2:
    ppl1.subprl2.path1 = f21
    ppl1.subprl2.path2 = f22
  ppl1.f3 = bind(f3, ppl1.input, _0, _1)
  
print("ppl1 out: ", ppl1(2))
```



è¾“å‡ºï¼š



```bash
ppl1 out:  get [input:2], [f21:5], [f23: 3]]
```



>æ³¨æ„ï¼Œå‚æ•°ç»‘å®šä»…åœ¨å½“å‰æ•°æ®æµå†…ç”Ÿæ•ˆï¼Œæ‚¨æ— æ³•å°†å¤–éƒ¨å˜é‡æ•°æ®ç»‘å®šè‡³æ•°æ®æµå†…ï¼Œä¹Ÿæ— æ³•è·¨æ•°æ®æµè¿›è¡Œæ•°æ®ç»‘å®šã€‚

[ç›¸å…³è§†é¢‘ï¼švideo/8jump1.mp4](video/8jump1.mp4)


LazyLLMä¸º bind å‡½æ•°é‡è½½äº† | è¿ç®—ç¬¦ï¼Œå¯ä»¥é€šè¿‡å®ƒå®ç°æ›´ç›´è§‚çš„å‚æ•°ç»‘å®šï¼Œå°†å‡½æ•°å’Œå‚æ•°åŒºåˆ†å¼€æ¥ï¼ˆ|è¿ç®—ç¬¦ä¹‹å‰çš„æ˜¯è¢«ç»‘å®šçš„å‡½æ•°ï¼Œä¹‹åæ˜¯éœ€è¦ç»‘å®šçš„å‚æ•°ï¼‰ã€‚æ­¤å¤–ï¼Œå­æ•°æ®æµä¹Ÿæ”¯æŒç»‘å®šå…¥å‚ã€‚ä¸‹é¢æˆ‘ä»¬å°†ä¸Šå›¾ä¿®æ”¹ä¸ºæ›´å¤æ‚çš„æµï¼Œæˆ‘ä»¬å°†æ•°æ®æµè¾“å…¥ç»‘å®šä¸ºsubprl2çš„ç¬¬ä¸€ä¸ªè¾“å…¥(ä¸‹å›¾çº¢è‰²ç®­å¤´çº¿)ï¼Œä¸Šæ¸¸f1çš„è¾“å‡ºä¸ºsubprlçš„ç¬¬äºŒä¸ªè¾“å…¥ã€‚

![image.png](3_images/img6.png)



[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter3/bind_more.py#L1)

```python
from lazyllm import pipeline, parallel, bind, _0, _1

with pipeline() as ppl1:
  ppl1.f1 = f1
  with parallel().bind(ppl1.input, _0) as ppl1.subprl2:
    ppl1.subprl2.path1 = f21
    ppl1.subprl2.path2 = f22
  ppl1.f3 = f3 | bind(ppl1.input, _0, _1)
  
print("ppl1 out: ", ppl1(2))
```



è¾“å‡ºï¼š



```bash
ppl1 out:  get [input:2], [f21:7], [f23: 5]]
```



[ç›¸å…³è§†é¢‘ï¼švideo/8jump2.mp4](video/8jump2.mp4)


## åŸºäº LazyLLM å®ç°RAG

åœ¨åŸºç¡€1ä¸­æˆ‘ä»¬ä»‹ç»äº†ragçš„å…·ä½“åŸç†åŠå®ç°è¿‡ç¨‹ï¼Œç®€å•RAGçš„æ¨ç†æ­¥éª¤åªæœ‰ä¸‰æ­¥ï¼Œå³æ£€ç´¢ã€å¢å¼ºã€ç”Ÿæˆã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢è®²è¿°çš„æ•°æ®æµæ¥é‡æ–°å®ç°ä¸€ä¸‹è¿™ä¸ªRAGï¼Œä½¿å¾—åˆ°ä¸€ä¸ªæ›´æ¸…æ™°çš„ä»£ç å—ã€‚è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š



```python
import lazyllm
from lazyllm import bind

# æ–‡æ¡£åŠ è½½
documents = lazyllm.Document(dataset_path="/mnt/lustre/share_data/dist/cmrc2018/data_kb")
prompt = 'You will act as an AI question-answering assistant and complete a dialogue task. \
          In this task, you need to provide your answers based on the given context and questions.'

with lazyllm.pipeline() as ppl:
    # æ£€ç´¢ç»„ä»¶å®šä¹‰
    ppl.retriever = lazyllm.Retriever(doc=documents, group_name="CoarseChunk", similarity="bm25_chinese", topk=3)
    ppl.formatter = (lambda nodes, query: {"query": query, "context_str": "".join([node.get_content() for node in nodes])}) | bind(query=ppl.input)
    # ç”Ÿæˆç»„ä»¶å®šä¹‰
    ppl.llm = lazyllm.OnlineChatModule().prompt(lazyllm.ChatPrompter(instruction=prompt, extra_keys=['context_str']))

lazyllm.WebModule(ppl, port=23466).start().wait()
```



è®©æˆ‘ä»¬ä¸€æ­¥æ­¥ä¿®æ”¹ä¸ŠæœŸRAGå¹¶å®ç°åŸºäºæ•°æ®æµçš„RAG:

[ç›¸å…³è§†é¢‘ï¼švideo/rag_pipeline.mp4](video/rag_pipeline.mp4)




